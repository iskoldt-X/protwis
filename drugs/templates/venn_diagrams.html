{% extends "home/base.html" %}
{% load static %}
{% load structure_extras %}
{% block addon_css %}

<!-- styles needed? -->
<!-- <link href="{% static 'home/css/prettify.css' %}" rel="stylesheet" media="screen"> -->
<link href="{% static 'home/css/color_picker.css' %}" rel="stylesheet" media="screen">
<link href="{% static 'home/css/jquery.dataTables.min.css' %}" rel="stylesheet" media="screen">
<link href="{% static 'home/css/yadcf_bootstrap_version.css' %}" rel="stylesheet" media="screen">
<link href="{% static 'home/css/targetselect_functions.css' %}" rel="stylesheet" media="screen">
<link rel="stylesheet" href="{% static 'home/css/select2_4.1.0-rc.0._full.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'home/css/structure_browser.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'home/css/NewDrugsBrowser_datatables.min.css' %}" type="text/css"/>
<style type="text/css">
  
  textarea {
    resize: none;
    overflow: hidden;
  }
  canvas#test-canvas {
    display: none;
  }
  .venn-row {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

#jvenn-container {
    min-height: 300px;         /* Adjust height based on your Venn diagram size */
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    margin-left: 18%; /* Moves the container 20px to the right */
}

.border-left {
    border-left: 1px solid #cccccc !important; /* Adjust the width and color as needed */
}
/* Centered */
th .dt-column-order {
    margin-right: -12px; /* Shift the sort arrow to the right */
}
th .dt-column-title {
    /* padding-left: 24px; */
    margin-left: 24px;
}

.select2-search__field::placeholder{
    text-align:center;
}
.select2-container--default .select2-selection--multiple{
    overflow: hidden !important;
}
.row-count-info {
    display: inline-block;
    margin-left: 10px;
    font-weight: bold;
    color: #333;
}

</style>

{% endblock %}

{% block content %}

<div class="container">
  <div class="row">
    <div class="col-md-12 text-center">
      {% if layout == "drugs" %}
      <p>Click a Venn or table area to retrieve the agents/drugs with the given clinical phase profile.</p>
      {% else %}
      <p>Click a Venn or table area to retrieve the receptors with the given clinical phase profile.</p>
      {% endif %}
    </div>
  </div>

  <!-- Centered Venn Diagram Row -->
  <div class="row justify-content-center venn-row">
    <div class="col-md-6 d-flex justify-content-center align-items-center">
      <div id="jvenn-container">
        <!-- Venn diagram content will render here -->
      </div>
    </div>
  </div>

  <!-- Table Row (Unaffected by Flex) -->
  <div style="font-size: 11px; white-space: nowrap; display: none;" id="table-container">
    <div class="row mt-4">
      <div class="col-md-12">
        <table width="100%" class="display compact" id="receptor_table">
          <thead>
            <tr>
              <td colspan="13" style="text-align: center" data-dt-order="disable"></td>
            </tr>
            <tr>
              <th colspan="3" style="text-align:center">Drug/Agent</th>
              <th colspan="5" style="text-align:center;border-left: 1px solid #cccccc;">Target</th>
              <th colspan="3" style="text-align:center;border-left: 1px solid #cccccc;">Indication</th>
              <th colspan="2" style="text-align:center;border-left: 1px solid #cccccc;">Phase</th>
            </tr>
            <tr>
              <th style="text-align: center;">Name</th>
              <th style="text-align: center;">Type</th>
              <th style="text-align: center;">Modality</th>
              <th style="text-align: center;border-left: 1px solid #cccccc;">Gene</th>
              <th style="text-align: center;">Protein</th>
              <th style="text-align: center;">Receptor family</th>
              <th style="text-align: center;">Ligand type</th>
              <th style="text-align: center;">Class</th>
              <th style="text-align: center;border-left: 1px solid #cccccc">Indication</th>
              <th style="text-align: center;">ICD11</th>
              <th style="text-align: center;">Association score</th>
              <th style="text-align: center;border-left: 1px solid #cccccc;">Max</th>
              <th style="text-align: center;">Approved</th>
            </tr>
            <tr>
              <td style="text-align: center;" data-dt-order="disable"></td>
              <td style="text-align: center;" data-dt-order="disable"></td>
              <td style="text-align: center;" data-dt-order="disable"></td>
              <td style="text-align: center;border-left: 1px solid #cccccc;" data-dt-order="disable"></td>
              <td style="text-align: center;" data-dt-order="disable"></td>
              <td style="text-align: center;" data-dt-order="disable"></td>
              <td style="text-align: center;" data-dt-order="disable"></td>
              <td style="text-align: center;" data-dt-order="disable"></td>
              <td style="text-align: center;border-left: 1px solid #cccccc;" data-dt-order="disable"></td>
              <td style="text-align: center;" data-dt-order="disable"></td>
              <td style="text-align: center;" data-dt-order="disable"></td>
              <td style="text-align: center;border-left: 1px solid #cccccc;" data-dt-order="disable"></td>
              <td style="text-align: center;" data-dt-order="disable"></td>
            </tr>
          </thead>
        </table>
        <canvas id="test-canvas"></canvas>
      </div>
    </div>
  </div>
</div> 


{% endblock %}
{% block addon_js %}
<script src="{% static 'home/js/d3.min.js' %}"></script>
<script src="{% static 'home/js/newick.js' %}"></script>
<script src="{% static 'home/js/targetselect_functions.js' %}"></script>
<!-- <script src="{% static 'home/js/select2.js' %}"></script> -->
<script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"></script>
<script src="{% static 'home/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'home/js/paper-full.min.js' %}"></script>
<script src="{% static 'home/js/bootstrap-colorpicker.min.js' %}"></script>
<script src="{% static 'home/js/canvas2svg.js' %}"></script>
<script src="{% static 'home/js/jvenn.js' %}"></script>
<script src="{% static 'home/js/nv.d3.min.js' %}"></script>
<script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>
<script src="{% static 'home/js/saveSvg.js' %}"></script>
<script src="{% static 'home/js/select2_4.1.0-rc.0_full.js' %}"></script>
<script src="{% static 'home/js/DataTables_v2.0.5.js' %}"></script>
<script src="{% static 'home/js/dataTables.buttons_3_0_0.js' %}"></script>
<script src="{% static 'home/js/DataTables.Colvis.js' %}"></script>
<script src="{% static 'home/js/dataTables.responsive.js' %}"></script>
<script src="{% static 'home/js/NorgesDTFilterBuilder.js' %}"></script>


<script>
  ! function($) {
    $(function() {
      window.prettyPrint && prettyPrint()
    })
  }(window.jQuery)
</script>


<script type="text/javascript" charset="utf-8">
  $(document).ready(function(){
    paper.install(window);
    });
</script>

<script src="{% static 'home/js/selection.js' %}"></script>


<script language="Javascript">
//   //creating a dictionary for the path translation
  const trackTranslate = {
    '0123': "resultC111100",  '023': "resultC101100",  '123': "resultC011100",
    '012': "resultC111000",  '02': "resultC101000",  '12': "resultC011000",
    '013': "resultC110100",  '03': "resultC100100",  '13': "resultC010100",
    '01': "resultC110000",  '0': "resultC100000",  '1': "resultC010000",
    '23': "resultC001100", '2': "resultC001000", '3': "resultC000100"
  };

$(document).ready(function () {
var colorDefault = ["#5a9bd4", "#f15a60", "#808080", "#006600"],
    displayMode  = "classic",
    displaySwitch = false,
    displayStat  = false,
    shortNumber  = true,
    fontSize     = "16px",
    fontFamily   = "Arial";

var gdata = {{ phases_dict|safe }};
var gprotein_ID = {{ phases_dict_keys|safe }};
// var dict = {{ drug_dictionary|safe }};
var fullData = {{ Full_data|safe }};
const layout = "{{ layout|escapejs }}";
console.log(gprotein_ID)
console.log(gdata)

function getArrayFromData(gprotein) {
  var lines = gdata[gprotein].split("\n");
  var table = new Array();
  for (var lindex in lines) {
    table.push(lines[lindex].trim());
  } return (table);
}


function initializeDataTable(tableId, data) {
  
  // Add common column definitions
  var columnDefs = [
    { className: "dt-head-center dt-center dt-body-center expand", targets: "_all" },
    { className: 'border-left', targets: [3, 8, 12] }
];
  
  // Set order based on layout value: column 3 for "Targets" and column 0 for "Drugs"
  const order = layout === "targets" ? [3, "asc"] : [0, "asc"];

  // Define columns
  var columns = [
            {data: "Ligand name", name: "Ligand name", render: function (data, type, row, meta) {
                  if (type === 'display') {
                      // Ensure row.Variable exists
                      if (row && row.LigandID) {
                          data = '<a href="/ligand/' + row.LigandID + '/info" target="_blank">' + data + '</a>';
                      } else {
                          data = data || ''; // Fallback to plain text if Variable is missing
                      }
                  }
                  return data; // Ensure raw data is returned for filtering
              }
          },
          {data: "Drug type", name: "Drug type"},
          {data: "Modality", name: "Modality"},
          {
              data: "Gene name",
              name: "Gene name",
              render: function (data, type, row, meta) {
                  if (type === 'display') {
                      const originalData = data; // Raw data
                      const transformedData = data.replace('_human', '').toUpperCase(); // Transformed display value

                      return '<a href="/protein/' + originalData + '/" target="_blank">' + transformedData + '</a>';
                  } else if (type === 'filter') {
                      // Return transformed data for the filter dropdown
                      return data.replace('_human', '').toUpperCase();
                  }
                  return data; // Raw data for sorting
              }
          },
          {data: "Protein name", name: "Protein name"},
          {data: "Receptor family", name: "Receptor family"},
          {data: "Ligand type", name: "Ligand type"},
          {data: "Class", name: "Class", render: function (data) { return data.split(' (')[0]; }},
          {
    data: "Indication name",
    name: "Indication",
    render: function (data, type, row, meta) {
        if (type === 'display') {
            if (row && row.ICD11) {
                const transformedData = data || 'Unknown'; // Fallback if Indication name is missing
                const link = '/drugs/indication/' + row.ICD11 + '/'; // Create the link using row.ICD11
                return '<a href="' + link + '" target="_blank">' + transformedData + '</a>';
            } else {
                return data || ''; // Fallback to plain text if ICD11 is missing
            }
        } else if (type === 'filter') {
            // Provide the raw data for filtering
            return data || 'Unknown'; // Ensure it aligns with the displayed text
        }
        return data; // Use raw data for sorting
    }
},
          {data: "ICD11", name: "ICD11"},
          // {data: 'ATC', name: "ATC"},
          {data: 'Association score', name: "Association score",  render: function (data) {return data === "" || data === null ? data : parseFloat(data).toFixed(4);}}, // Format to 4 decimal places
          {data: "Phase", name: "Max"},
          {data: "Approved", name: "Approved"}
                      
      ];

  // Initialize or reinitialize DataTable
  if ($.fn.DataTable.isDataTable(tableId)) {
      var table = $(tableId).DataTable();
      table.clear();
      table.rows.add(data);
      table.draw();
      // Update row count after redrawing
      const totalRows = table.rows().count();
      const rowCountText = `Target-Drug/Agent-Indication rows: ${totalRows}`;
      $('.row-count-info').html(`<span class="row-count">${rowCountText}</span>`);
  } else {
      $(tableId).DataTable({
          dom: "<'row'<'col-sm-1 dt-btn'B><'col-sm-3'f><'col-sm-7 text-end'<'row-count-info'>>>" +  // Buttons and search bar in the same row
          "<'row'<'col-sm-12'tr>>" +                    // Table rows
          "<'row'<'col-sm-12'ip>>", // Pagination and info


          order: order,
          pageLength: 20,
          lengthMenu: [10, 20, { label: 'All', value: -1 }],
          data: data,
          columns: columns,
          columnDefs: columnDefs,
          autoWidth: false,  // Disable automatic column width calculation
          processing: false,
          deferRender: true,
          paging: true,
          autoWidth: false, // Prevent automatic column width adjustment
          // scrollX: false,
          buttons: [
              { text: 'Reset filters', action: function () { reset_all(); } }
          ],
          initComplete: function() {
              // Use `this.api()` to get the table instance inside initComplete
              const api = this.api(); // Access the DataTable API
              const totalRows = api.rows().count(); // Use the API to get row count
              const rowCountText = `Target-Drug/Agent-Indication rows: ${totalRows}`;
              $('.row-count-info').html(`<span class="row-count">${rowCountText}</span>`);
          }
      });
  }
  var column_filters = [];
  const Table_selector = $(tableId).DataTable();
  // CreateColumnFilters --> CreateColumnFilters(datatable_selector,column_number, column_range, filter_type)
      column_filters = column_filters.concat(CreateColumnFilters(Table_selector,0,10,"Multi-select-exact"));
      column_filters = column_filters.concat(CreateColumnFilters(Table_selector,10,2,"Range-float-vertical"));
      column_filters = column_filters.concat(CreateColumnFilters(Table_selector,12,1,"Multi-select-exact"));
  
  // Create the filteres
  createDropdownFilters(Table_selector,column_filters);
}

function reset_all() {
        $('.select2').val(null).trigger('change');
    }
// init datattable
// datatable = $("#receptor_table").DataTable(table_options);

function updateJvenn(gprotein_ID) {
  displaySwitch = false;
  var seriesTable = new Array();
  var num = 0;
  for(var i=1; i<=gprotein_ID.length; i++) {
    seriesTable.push({
      name: gprotein_ID[i-1],
      data: getArrayFromData(gprotein_ID[i-1])
    });
  }

    var vennColors = [
      "#f5bcbf",    // Bright Red for first circle
      "#f17270",    // Darker Red for second circle
      "#dd2628",    // Even darker Red for third circle
      "#2c87c8"     // Blue for the last circle
    ];
    $("#jvenn-container").jvenn({
      series: seriesTable,
      colors: vennColors,
      fontSize: fontSize,
      fontFamily: fontFamily,
      searchInput: $("#search-field"),
      searchStatus: $("#search-status"),
      displayMode: displayMode,
      shortNumber: shortNumber,
      displaySwitch: displaySwitch,
      displayStat: displayStat,
      exporting: true,
      fnClickCallback: function() {
        
        // Define the column to filter by and the values to match in that column
        // Set filterColumn based on the layout value
        const filterColumn = layout === "targets" ? "Gene name" : "Ligand name";

        // set filter values
        const filterValues = this.list;

        // Filter the data based on the specified column and values
        const selectedData = fullData.filter(row => filterValues.includes(row[filterColumn]));

        // Show the table only after the search is clicked
        $('#table-container').show();

        // reset filters
        reset_all();
        
        // Pass selected data to initializeDataTable function
        initializeDataTable("#receptor_table", selectedData);
      }
    });

    // Handle clicks on phase labels
    $("#label1, #label2, #label3, #label4").off("click").on("click", function () {
      const phaseLabel = $(this).text().trim(); // Get the clicked label's text, e.g., "Phase I"

      // Use gdata to get the newline-separated list for the phase
      const filterValues = gdata[phaseLabel].split("\n").map((item) => item.trim());

      // Define the column to filter by based on layout
      const filterColumn = layout === "targets" ? "Gene name" : "Ligand name";

      // Filter the fullData based on the selected phase's filter values
      const selectedData = fullData.filter((row) =>
        filterValues.includes(row[filterColumn])
      );

      // Show the filtered table
      $("#table-container").show();

      // Reset filters
      reset_all();

      // Pass the filtered data to initializeDataTable function
      initializeDataTable("#receptor_table", selectedData);
    });

    // Helper function to convert HEX to RGB
    function hexToRgb(hex) {
      // Remove the hash at the start if it's there
      hex = hex.replace(/^#/, '');

      // Parse the r, g, b values
      var bigint = parseInt(hex, 16);
      var r = (bigint >> 16) & 255;
      var g = (bigint >> 8) & 255;
      var b = bigint & 255;

      return [r, g, b];
    }

    // Function to blend colors from the 'included' list
    function blendColors(included) {
      var totalColors = included.length;
      var avgR = 0, avgG = 0, avgB = 0;

      // Sum up the RGB components of all included colors
      included.forEach(function(index) {
        var [r, g, b] = hexToRgb(vennColors[index]);
        avgR += r / totalColors;
        avgG += g / totalColors;
        avgB += b / totalColors;
      });

      // Ensure values are integers
      avgR = Math.round(avgR);
      avgG = Math.round(avgG);
      avgB = Math.round(avgB);

      // Return the blended color as an RGB string
      return `rgb(${avgR},${avgG},${avgB})`;
    }

    var totalCount = 0;
    $(".number-black").each(function() {
      totalCount = totalCount + parseInt($(this).text());
    });

    var paper_paths = [];
    paper.setup("test-canvas");

    // Setup paths and apply the fill opacity for blending
    $("#canvasEllipse svg g g").each(function(index) {
      var transform = this.getAttribute("transform").parseTransform();
      paper_paths[index] = new paper.Path(this.firstChild.getAttribute("d"));
      paper_paths[index].scale(transform.scale.x, transform.scale.y);
      paper_paths[index].translate(transform.translate.x, transform.translate.y);
      paper_paths[index].rotate(transform.rotate.a);

      // Apply solid colors initially (if needed)
      paper_paths[index].fillColor = vennColors[index] || '#000000';
    });

    // Handle all possible combinations and overlaps
    var sets = Array.from(Array(paper_paths.length).keys());
    var combinations = getCombinations([...sets]);

    for (var i = 0; i < combinations.length; i++) {
      var included = combinations[i];
      track = trackTranslate[included.join('')];
      if (included.length > 0) {
        var excluded = sets.filter(value => !included.includes(value));
        var result = paper_paths[included[0]];

        for (var j = 1; j < included.length; j++) {
          result = result.intersect(paper_paths[included[j]]);
        }

        for (var j = 0; j < excluded.length; j++) {
          result = result.subtract(paper_paths[excluded[j]]);
        }

        var svgPathElement = result.exportSVG();
        var dPath = svgPathElement.getAttribute('d');

        // Blend the colors of the overlapping circles
        var blendedColor = blendColors(included);
        let g = $("#canvasEllipse svg g").get(0);
        var newElement = document.createElementNS("http://www.w3.org/2000/svg", 'path');
        newElement.setAttribute("d", dPath);
        newElement.setAttribute("fill-opacity", 0.5); // Adjust opacity for blending
        newElement.style.fill = blendedColor;
        g.appendChild(newElement);
      }
    }

    // Apply base styles to the labels
    $("#label1, #label2, #label3, #label4").css({
      "font-weight": "bold",
      "color": "#007bff", /* Blue color for text */
      "text-decoration": "underline", /* Underline the text */
      "font-size": "18px",
      "opacity": "1",
      "cursor": "pointer", // Makes the labels look clickable
      "transition": "color 0.3s, text-decoration 0.3s, background-color 0.3s" // Smooth transitions
    });

    // Add hover effects dynamically
    $("#label1, #label2, #label3, #label4").off("mouseenter mouseleave") // Remove previous bindings
      .on("mouseenter", function () {
        $(this).css({
          "color": "#0056b3", /* Darker blue on hover */
          "text-decoration": "underline" // Keep underline
        });
      })
      .on("mouseleave", function () {
        $(this).css({
          "color": "#007bff", /* Reset to original blue */
          "text-decoration": "underline" // Keep underline
        });
      });

      // Apply base styles to the labels
      $(".number-black").css({
        "font-weight": "bold",
        "text-decoration": "underline", /* Underline the text */
        "font-size": "19px",
        "opacity": "1",
        "cursor": "pointer", // Makes the labels look clickable
        "transition": "color 0.3s, text-decoration 0.3s, background-color 0.3s" // Smooth transitions
      });

    // Add hover effects dynamically
    $(".number-black").off("mouseenter mouseleave") // Remove previous bindings
      .on("mouseenter", function () {
        $(this).css({
          "color": "#0056b3", /* Darker blue on hover */
          "text-decoration": "underline", // Keep underline
        });
      })
      .on("mouseleave", function () {
        $(this).css({
          "color": "Black", /* Reset to original blue */
          "text-decoration": "underline", // Keep underline
        });
      });

    $("#label4").css({
      "width": "auto", // This ensures the div resizes automatically based on the text length
      "white-space": "nowrap" // Prevents the text from breaking into multiple lines
    });

    $(".number-empty").html("-");
    // $("#frame").css({
    //   "left": "50%"
    // });
    // $("#module-export").css({
    //   "left": "750px"
    // });
  }

updateJvenn(gprotein_ID)

});
</script>

<script>
  // Transform parser
  String.prototype.parseTransform = function() {
  	var prop = ['translate', 'matrix', 'rotate', 'skewX', 'skewY', 'scale'];
  	var val = this.match(/(translate|matrix|rotate|skewX|skewY|scale)\(.*?\)/g);
  	var obj = {};
  	if (val) {
  		for (var i = 0, length = val.length; i < length; i++) {
  			var item = val[i];
  			var index = item.indexOf('(');
  			var v = item.substring(index + 1, item.length - 1).split(/\,|\s/);
  			var n = item.substring(0, index);
  			obj[n] = {};
  			switch (n) {
  				case 'translate':
  				case 'scale':
  					obj[n].x = +v[0] || 0;
  					obj[n].y = +v[1] || 0;
  					break;
  				case 'rotate':
  					obj[n].a = +v[0] || 0;
  					obj[n].x = +v[1] || 0;
  					obj[n].y = +v[2] || 0;
  					break;
  				case 'skewX':
  				case 'skewY':
  					obj[n].a = +v[0];
  					break;
  				case 'matrix':
  					obj[n].a = +v[0] || 0;
  					obj[n].b = +v[1] || 0;
  					obj[n].c = +v[2] || 0;
  					obj[n].d = +v[3] || 0;
  					obj[n].e = +v[4] || 0;
  					obj[n].f = +v[5] || 0;
  					break;
  			}
  		}
  	}

  	obj.toString = function() {
  		var builder = [];
  		for (var i = 0, length = prop.length; i < length; i++) {
  			var n = prop[i];
  			var o = this[n];
  			if (!o)
  				continue;
  			switch (n) {
  				case 'translate':
  				case 'scale':
  					builder.push(n + '(' + o.x + ',' + o.y + ')');
  					break;
  				case 'rotate':
  					builder.push(n + '(' + o.a + ' ' + o.x + ' ' + o.y + ')');
  					break;
  				case 'skewX':
  				case 'skewY':
  					builder.push(n + '(' + o.a + ')');
  					break;
  				case 'matrix':
  					builder.push(n + '(' + o.a + ',' + o.b + ',' + o.c + ',' + o.d + ',' + o.e + ',' + o.f + ')');
  					break;
  			}
  		}
  		return builder.join(' ');
  	};

  	return obj;
  };


  function getCombinations(array) {
      function iter(temp, index) {
          if (index >= array.length) {
              result.push(temp);
              return;
          }

          iter([...temp, array[index]], index + 1);
          iter(temp, index + 1);
      }

      var result = [];
      iter([], 0);
      return result;
  }
  function componentToHex(c)
  {
      var hex = c.toString(16);
      return hex.length == 1 ? "0" + hex : hex;
  }
</script>

<script language='Javascript'>
  function highlightBG(element, color) {
      element.style.backgroundColor = color;
  }
  function linkLikeClick(element, color) {
      element.style.color = color;
      // element.style.textDecoration = 'underline';
  }
  </script>

{% endblock %}
