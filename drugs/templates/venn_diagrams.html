{% extends "home/base.html" %}
{% load static %}
{% load structure_extras %}
{% block addon_css %}
{% endblock %}
{% block content %}

<!-- styles needed? -->
<!-- <link href="{% static 'home/css/prettify.css' %}" rel="stylesheet" media="screen"> -->
<link href="{% static 'home/css/color_picker.css' %}" rel="stylesheet" media="screen">
<link href="{% static 'home/css/jquery.dataTables.min.css' %}" rel="stylesheet" media="screen">
<link href="{% static 'home/css/yadcf_bootstrap_version.css' %}" rel="stylesheet" media="screen">
<link href="{% static 'home/css/targetselect_functions.css' %}" rel="stylesheet" media="screen">
<link href="{% static 'home/css/select2.css' %}" rel="stylesheet" media="screen">

<script src="{% static 'home/js/selection.js' %}"></script>


<script language="Javascript">
  //creating a dictionary for the path translation
  const trackTranslate = {
    '0123': "resultC111100",  '023': "resultC101100",  '123': "resultC011100",
    '012': "resultC111000",  '02': "resultC101000",  '12': "resultC011000",
    '013': "resultC110100",  '03': "resultC100100",  '13': "resultC010100",
    '01': "resultC110000",  '0': "resultC100000",  '1': "resultC010000",
    '23': "resultC001100", '2': "resultC001000", '3': "resultC000100"
  };

  function clear_select_segmentselection(form) {

    ClearSelection('targets')
    //Dealing with csrf token
    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) c_end = document.cookie.length;
                return unescape(document.cookie.substring(c_start, c_end));
            }
        }
        return "";
    }
    $.ajaxSetup({
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    });
    //Actual post
    var fd = new FormData(form);
    $.ajax({
        type: 'POST',
        url: '/common/targetformread',
        data: fd,
        cache: false,
        processData: false,
        contentType: false,
        'success': function (data) {
            location.href="/alignment/segmentselection";
            console.log('ready!');
        },
    }).fail(function (jqXHR, textStatus, error) {
        alert("Request failed: " + textStatus + error);
    });
    return false;
}

function copyToClipboard(txt) {
    var cb = document.getElementById("cb");
    cb.value = txt.slice(0, -1);
    cb.style.display='block';
    cb.select();
    document.execCommand('copy');
    cb.style.display='none';
    showAlert("Selected receptors have been copied to your clipboard.", "info");
}

      $(document).ready(function () {
        var colorDefault = ["#5a9bd4", "#f15a60", "#808080", "#006600"],
          displayMode  = "classic",
          displaySwitch = false,
          displayStat  = false,
          shortNumber  = true,
          fontSize     = "16px",
          fontFamily   = "Arial";

          gdata = {{ phases_dict|safe }};
          gprotein_ID = {{ phases_dict_keys|safe }};

        function getArrayFromData(gprotein) {
          var lines = gdata[gprotein].split("\n");
          var table = new Array();
          for (var lindex in lines) {
            table.push(lines[lindex].trim());
          }
          return (table);
        }

        var table_options = {
                         "paging":       false,
                         "lengthChange": false,
                         "order":        [[ 3, "desc" ]],
                         "scrollX":      false,
                         "deferRender": true,
                        }
        // init datattable
        datatable = $("#receptor_table").DataTable(table_options);

        var yadcf_options = [];
        var list = [0, 1, 2, 3, 4, 5, 6, 7];
        for (i in list){
          yadcf_options.push({
            column_number : list[i],
            filter_type: "multi_select",
            select_type: "select2",
            filter_default_label: "",
            filter_reset_button_text: false,
            select_type_options: {
                width: "80%",
            }
          });
        }
        // init yadcf
        yadcf.init(datatable, yadcf_options);
        function updateJvenn(gprotein_ID) {
          displaySwitch = false;
          var seriesTable = new Array();
          var num = 0;
          for(var i=1; i<=gprotein_ID.length; i++) {
            seriesTable.push({
              name: gprotein_ID[i-1],
              data: getArrayFromData(gprotein_ID[i-1])
            });
          }

            var vennColors = [
              "#f5bcbf",    // Bright Red for first circle
              "#f17270",    // Darker Red for second circle
              "#dd2628",    // Even darker Red for third circle
              "#2c87c8"     // Blue for the last circle
            ];
            $("#jvenn-container").jvenn({
              series: seriesTable,
              colors: vennColors,
              fontSize: fontSize,
              fontFamily: fontFamily,
              searchInput: $("#search-field"),
              searchStatus: $("#search-status"),
              displayMode: displayMode,
              shortNumber: shortNumber,
              displaySwitch: displaySwitch,
              displayStat: displayStat,
              exporting: true,
              fnClickCallback: function() {
                var dict = {{ drug_dictionary|safe }};
                var value = "";
                datatable.clear().draw();
                for (val in this.list) {
                  item = this.list[val].toLowerCase().replace(/^\w/, c => c.toUpperCase());
                  console.log(item);
                  console.log(dict[item]);
                  for (let record of dict[item]){
                    datatable.row.add([
                      record[0],
                      record[1],
                      record[2],
                      record[3],
                      record[4],
                      record[5],
                      record[6],
                      record[7],
                    ]);
                  }
                  value += this.list[val] + " ";
                }
                datatable.draw();
                $("td").each(function() {
                  $(this).addClass("expand");
                });
                $("#copytoclip").unbind("click");
                $("#copytoclip").bind("click", function(event) {
                  copyToClipboard(value);
                });
              }
            });

            // Helper function to convert HEX to RGB
            function hexToRgb(hex) {
              // Remove the hash at the start if it's there
              hex = hex.replace(/^#/, '');

              // Parse the r, g, b values
              var bigint = parseInt(hex, 16);
              var r = (bigint >> 16) & 255;
              var g = (bigint >> 8) & 255;
              var b = bigint & 255;

              return [r, g, b];
            }

            // Function to blend colors from the 'included' list
            function blendColors(included) {
              var totalColors = included.length;
              var avgR = 0, avgG = 0, avgB = 0;

              // Sum up the RGB components of all included colors
              included.forEach(function(index) {
                var [r, g, b] = hexToRgb(vennColors[index]);
                avgR += r / totalColors;
                avgG += g / totalColors;
                avgB += b / totalColors;
              });

              // Ensure values are integers
              avgR = Math.round(avgR);
              avgG = Math.round(avgG);
              avgB = Math.round(avgB);

              // Return the blended color as an RGB string
              return `rgb(${avgR},${avgG},${avgB})`;
            }

            var totalCount = 0;
            $(".number-black").each(function() {
              totalCount = totalCount + parseInt($(this).text());
            });

            var paper_paths = [];
            paper.setup("test-canvas");

            // Setup paths and apply the fill opacity for blending
            $("#canvasEllipse svg g g").each(function(index) {
              var transform = this.getAttribute("transform").parseTransform();
              paper_paths[index] = new paper.Path(this.firstChild.getAttribute("d"));
              paper_paths[index].scale(transform.scale.x, transform.scale.y);
              paper_paths[index].translate(transform.translate.x, transform.translate.y);
              paper_paths[index].rotate(transform.rotate.a);

              // Apply solid colors initially (if needed)
              paper_paths[index].fillColor = vennColors[index] || '#000000';
            });

            // Handle all possible combinations and overlaps
            var sets = Array.from(Array(paper_paths.length).keys());
            var combinations = getCombinations([...sets]);

            for (var i = 0; i < combinations.length; i++) {
              var included = combinations[i];
              track = trackTranslate[included.join('')];
              if (included.length > 0) {
                var excluded = sets.filter(value => !included.includes(value));
                var result = paper_paths[included[0]];

                for (var j = 1; j < included.length; j++) {
                  result = result.intersect(paper_paths[included[j]]);
                }

                for (var j = 0; j < excluded.length; j++) {
                  result = result.subtract(paper_paths[excluded[j]]);
                }

                var svgPathElement = result.exportSVG();
                var dPath = svgPathElement.getAttribute('d');

                // Blend the colors of the overlapping circles
                var blendedColor = blendColors(included);
                let g = $("#canvasEllipse svg g").get(0);
                var newElement = document.createElementNS("http://www.w3.org/2000/svg", 'path');
                newElement.setAttribute("d", dPath);
                newElement.setAttribute("fill-opacity", 0.5); // Adjust opacity for blending
                newElement.style.fill = blendedColor;
                g.appendChild(newElement);
              }
            }

            $("#label1, #label2, #label3, #label4").css({
                "font-weight": "bold",
                "font-size": "20px",
                "opacity": "1"
            });
            $("#label4").css({
                "width": "auto",  // This ensures the div resizes automatically based on the text length
                "white-space": "nowrap"  // Prevents the text from breaking into multiple lines
            });
            $(".number-empty").html("-");
            // $("#frame").css({
            //   "left": "50%"
            // });
            // $("#module-export").css({
            //   "left": "750px"
            // });
          }

        updateJvenn(gprotein_ID)

    });
  </script>

<script>
  // Transform parser
  String.prototype.parseTransform = function() {
  	var prop = ['translate', 'matrix', 'rotate', 'skewX', 'skewY', 'scale'];
  	var val = this.match(/(translate|matrix|rotate|skewX|skewY|scale)\(.*?\)/g);
  	var obj = {};
  	if (val) {
  		for (var i = 0, length = val.length; i < length; i++) {
  			var item = val[i];
  			var index = item.indexOf('(');
  			var v = item.substring(index + 1, item.length - 1).split(/\,|\s/);
  			var n = item.substring(0, index);
  			obj[n] = {};
  			switch (n) {
  				case 'translate':
  				case 'scale':
  					obj[n].x = +v[0] || 0;
  					obj[n].y = +v[1] || 0;
  					break;
  				case 'rotate':
  					obj[n].a = +v[0] || 0;
  					obj[n].x = +v[1] || 0;
  					obj[n].y = +v[2] || 0;
  					break;
  				case 'skewX':
  				case 'skewY':
  					obj[n].a = +v[0];
  					break;
  				case 'matrix':
  					obj[n].a = +v[0] || 0;
  					obj[n].b = +v[1] || 0;
  					obj[n].c = +v[2] || 0;
  					obj[n].d = +v[3] || 0;
  					obj[n].e = +v[4] || 0;
  					obj[n].f = +v[5] || 0;
  					break;
  			}
  		}
  	}

  	obj.toString = function() {
  		var builder = [];
  		for (var i = 0, length = prop.length; i < length; i++) {
  			var n = prop[i];
  			var o = this[n];
  			if (!o)
  				continue;
  			switch (n) {
  				case 'translate':
  				case 'scale':
  					builder.push(n + '(' + o.x + ',' + o.y + ')');
  					break;
  				case 'rotate':
  					builder.push(n + '(' + o.a + ' ' + o.x + ' ' + o.y + ')');
  					break;
  				case 'skewX':
  				case 'skewY':
  					builder.push(n + '(' + o.a + ')');
  					break;
  				case 'matrix':
  					builder.push(n + '(' + o.a + ',' + o.b + ',' + o.c + ',' + o.d + ',' + o.e + ',' + o.f + ')');
  					break;
  			}
  		}
  		return builder.join(' ');
  	};

  	return obj;
  };


  function getCombinations(array) {
      function iter(temp, index) {
          if (index >= array.length) {
              result.push(temp);
              return;
          }

          iter([...temp, array[index]], index + 1);
          iter(temp, index + 1);
      }

      var result = [];
      iter([], 0);
      return result;
  }
  function componentToHex(c)
  {
      var hex = c.toString(16);
      return hex.length == 1 ? "0" + hex : hex;
  }
</script>

<style type="text/css">
  /* Maintain original width of page */
  /* @media (min-width: 1600px) {
    #content.container {
      width: 1570px;
    }
  } */
  textarea {
    resize: none;
    overflow: hidden;
  }
  canvas#test-canvas {
    display: none;
  }

</style>
<script language='Javascript'>
function highlightBG(element, color) {
    element.style.backgroundColor = color;
}
function linkLikeClick(element, color) {
    element.style.color = color;
    // element.style.textDecoration = 'underline';
}
</script>
<div class="container">
  <div class="row">
    <div class="col-md-12" style="justify-content: center;">
      <div class="text-center">
        {% if layout == "drugs" %}
        <p>	Click a Venn or table area to retrieve the agents/drugs with the given clinical phase profile. </p>
        {% else %}
        <p>	Click a Venn or table area to retrieve the receptors with the given clinical phase profile. </p>
        {% endif %}
      </div>
      <div id="jvenn-container"></div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <table class="compact text-nowrap" id="receptor_table">
        <thead>
          <tr>
              <th>Ligand name</th>
              <th>Ligand type</th>
              <th>Receptor Family</th>
              <th>Receptor<br>(UniProt)</th>
              <th>Receptor<br>(GtP)</th>
              <th>Clinical phase</th>
              <th>Indication</th>
              <th>ICD code</th>
          </tr>
          <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
          </tr>
        </thead>
      </table>
      <button id="copytoclip" type="button" class="btn btn-info" style="float:right;margin-top:10px;"> Copy receptor names to clipboard </button>
      <input id="cb" type="text" hidden>
      <canvas id="test-canvas"></canvas>
    </div>
  </div>
  <hr>
</div>

<script>
  ! function($) {
    $(function() {
      window.prettyPrint && prettyPrint()
    })
  }(window.jQuery)
</script>


<script type="text/javascript" charset="utf-8">
  var drug_dictionary = {{ drug_dictionary|safe }};
  $(document).ready(function(){
    paper.install(window);
    });
</script>


{% endblock %}
{% block addon_js %}
<script src="{% static 'home/js/d3.min.js' %}"></script>
<script src="{% static 'home/js/newick.js' %}"></script>
<script src="{% static 'home/js/targetselect_functions.js' %}"></script>
<script src="{% static 'home/js/select2.js' %}"></script>
<script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"></script>
<script src="{% static 'home/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'home/js/paper-full.min.js' %}"></script>
<script src="{% static 'home/js/bootstrap-colorpicker.min.js' %}"></script>
<script src="{% static 'home/js/canvas2svg.js' %}"></script>
<script src="{% static 'home/js/jvenn.js' %}"></script>
<script src="{% static 'home/js/nv.d3.min.js' %}"></script>
<script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>
<script src="{% static 'home/js/saveSvg.js' %}"></script>
{% endblock %}
